#!/bin/sh -e
# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

USAGE="${0##*/} -p|--poke|-deactivate|--daemon
${0##*/} -i|--inhibit [command [params ...]]
Interfaces with Chromium OS's powerd to prevent the system from suspending.

Passes parameters to the appropriate command if called as xscreensaver-command
or gnome-screensaver-command.

Options:
    -i --inhibit           Inhibits powerd for the duration of the command, or
                           forever if no command is specified.
    -p --poke -deactivate  Pings powerd to prevent activation.
    --daemon               Enters daemon mode where idleness and screensaver
                           inhibition are passed on to Chromium OS's powerd."

INHIBITSLEEP='30'
DAEMONSLEEP='15'

# Check if we need to pass through to another command
EXEC="${0##*/}"
case "$EXEC" in
gnome-screensaver-command|xscreensaver-command) EXEC="/usr/bin/$EXEC";;
*) EXEC='';;
esac

# Check what command we need to run, or immediately pass through if unrecognized
case "$1" in
-i|--inhibit) CMD='i';;
-p|--poke|-deactivate) CMD='p';;
--daemon) CMD='d'
    if [ -n "$EXEC" ]; then
        exec "$EXEC" "$@"
    fi;;
*)  if [ -z "$EXEC" ]; then
        echo "$USAGE" 1>&2
        exit 2
    fi
    exec "$EXEC" "$@";;
esac

pingpowerd() {
    host-dbus dbus-send --system --dest=org.chromium.PowerManager \
                        --type=method_call /org/chromium/PowerManager \
                        org.chromium.PowerManager.HandleUserActivity || true
}

if [ "$CMD" = 'p' ]; then
    # Ping
    pingpowerd
    exec "${EXEC:-"true"}" "$@"
elif [ "$CMD" = 'i' ]; then
    # Inhibit
    pid=''
    if [ -n "$EXEC" ]; then
        "$EXEC" "$@" &
        pid=$!
    elif [ -n "$2" ]; then
        shift
        "$@" &
        pid=$!
    fi
    if [ -n "$pid" ]; then
        TRAP="kill $pid 2>/dev/null || true;$TRAP"
        trap "$TRAP" INT HUP 0
    fi
    while [ -z "$pid" -o -d "/proc/$pid" ]; do
        pingpowerd
        sleep "$INHIBITSLEEP"
    done
else
    # Daemon
    xdgs='/usr/bin/xdg-screensaver'
    xi2pid=''

    # Send pings to powerd at regular intervals, if the user is active (i.e.
    # there are input events), or if the screensaver is disabled.
    # For performance reason, we probably do not want to monitor every single
    # X input events. Therefore, we start a subshell that pings powerd upon
    # receiving a single event, then quits.
    # Every $DAEMONSLEEP seconds we check if that subshell if alive, and
    # restart it if necessary. This means that we miss events during up to 
    # $DAEMONSLEEP seconds, and, if powerd timeout is X seconds, then the
    # screen may already dim after X-DAEMONSLEEP seconds of inactivity. This is
    # not noticeable if DAEMONSLEEP is much smaller than X (usually, X=300s).

    while [ 1 ]; do
        if [ "`"$xdgs" status 2>/dev/null`" = 'disabled' ]; then
            # Screensaver disabled: ping
            pingpowerd
        elif ! jobs "%-" >/dev/null 2>&1; then
            # croutonxi2event subshell is not running

            # Fail if return status from process != 0 (through -e)
            if [ -z "xi2pid" ]; then
                wait $xi2pid
            fi

            # Wait for input event, then ping immediately
            ( croutonxi2event -1 >/dev/null 2>&1 && pingpowerd ) &
            xi2pid=$!
        fi
        sleep "$DAEMONSLEEP"
    done
fi

exit 0
